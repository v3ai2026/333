name: 🚀 自动检查和部署

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  check-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # ====================================================================
      # 📥 1. 检出代码
      # ====================================================================
      - name: 📥 检出代码
        uses: actions/checkout@v4
      
      # ====================================================================
      # 🐍 2. Python 语法检查
      # ====================================================================
      - name: 🐍 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: 🐍 安装 Python 依赖和 flake8
        run: |
          python -m pip install --upgrade pip
          pip install flake8
          if [ -f backend-service/requirements.txt ]; then
            pip install -r backend-service/requirements.txt
          fi
      
      - name: 🐍 Python 语法检查 (flake8)
        run: |
          echo "🔍 正在运行 Python 语法检查..."
          # 检查所有 Python 文件
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || echo "⚠️ 发现语法错误"
          # 运行完整的 flake8 检查（警告不会导致失败）
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
          echo "✅ Python 语法检查完成"
      
      # ====================================================================
      # 🔨 3. Docker 配置验证
      # ====================================================================
      - name: 🔨 验证 Docker 配置
        run: |
          echo "🔍 验证 docker-compose.yml..."
          docker-compose config > /dev/null
          echo "✅ Docker 配置验证通过"
      
      # ====================================================================
      # 📝 4. 环境变量设置
      # ====================================================================
      - name: 📝 设置环境变量
        run: |
          echo "📝 创建 .env 文件..."
          cp .env.example .env
          
          # 设置测试环境变量
          sed -i 's/APP_ENV=production/APP_ENV=testing/' .env
          sed -i 's/APP_DEBUG=false/APP_DEBUG=true/' .env
          sed -i 's/MYSQL_ROOT_PASSWORD=.*/MYSQL_ROOT_PASSWORD=test_root_password/' .env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=test_password/' .env
          sed -i 's/MYSQL_PASSWORD=.*/MYSQL_PASSWORD=test_password/' .env
          sed -i 's/REDIS_PASSWORD=.*/REDIS_PASSWORD=/' .env
          
          # 生成 APP_KEY
          APP_KEY=$(openssl rand -base64 32)
          sed -i "s|APP_KEY=.*|APP_KEY=base64:$APP_KEY|g" .env
          
          # 创建 backend-service .env（如果不存在）
          if [ ! -f backend-service/.env ]; then
            echo "PORT=8080" > backend-service/.env
            echo "APP_DEBUG=true" >> backend-service/.env
            echo "GCP_PROJECT_ID=test-project" >> backend-service/.env
            echo "GCP_REGION=us-central1" >> backend-service/.env
            echo "VERTEX_AI_ENABLED=false" >> backend-service/.env
          fi
          
          echo "✅ 环境变量配置完成"
      
      # ====================================================================
      # 🔨 5. 构建 Docker 镜像
      # ====================================================================
      - name: 🔨 构建 Docker 镜像
        run: |
          echo "🏗️ 开始构建 Docker 镜像..."
          echo "⏰ 构建开始时间: $(date)"
          
          # 构建所有镜像
          docker-compose build --no-cache
          
          echo "✅ Docker 镜像构建完成"
          echo "⏰ 构建完成时间: $(date)"
          
          # 显示构建的镜像
          echo "📦 已构建的镜像:"
          docker images | grep -E "magicai|333"
      
      # ====================================================================
      # 🚀 6. 启动所有服务
      # ====================================================================
      - name: 🚀 启动所有服务
        run: |
          echo "🚀 启动 Docker 容器..."
          docker-compose up -d
          
          echo "✅ 容器启动命令已执行"
          echo ""
          echo "📋 容器状态:"
          docker-compose ps
      
      # ====================================================================
      # ⏳ 7. 等待服务就绪
      # ====================================================================
      - name: ⏳ 等待数据库就绪
        run: |
          echo "⏳ 等待 MySQL 数据库初始化..."
          for i in {1..60}; do
            if docker-compose exec -T db mysqladmin ping -h localhost -u root -ptest_root_password &> /dev/null; then
              echo "✅ 数据库已就绪"
              break
            fi
            echo "⏳ 等待中... ($i/60)"
            sleep 2
          done
          
          # 验证数据库确实就绪
          if ! docker-compose exec -T db mysqladmin ping -h localhost -u root -ptest_root_password &> /dev/null; then
            echo "❌ 数据库启动超时"
            docker-compose logs db
            exit 1
          fi
      
      - name: ⏳ 等待 Redis 就绪
        run: |
          echo "⏳ 等待 Redis 启动..."
          for i in {1..30}; do
            if docker-compose exec -T redis redis-cli ping &> /dev/null; then
              echo "✅ Redis 已就绪"
              break
            fi
            echo "⏳ 等待中... ($i/30)"
            sleep 1
          done
      
      - name: ⏳ 等待 Web 应用就绪
        run: |
          echo "⏳ 等待 Web 应用启动..."
          for i in {1..60}; do
            if curl -s http://localhost:8000 &> /dev/null; then
              echo "✅ Web 应用已就绪"
              break
            fi
            echo "⏳ 等待中... ($i/60)"
            sleep 3
          done
      
      - name: ⏳ 等待 Python 后端就绪
        run: |
          echo "⏳ 等待 Python 后端启动..."
          for i in {1..60}; do
            if curl -s http://localhost:8080/health &> /dev/null; then
              echo "✅ Python 后端已就绪"
              break
            fi
            echo "⏳ 等待中... ($i/60)"
            sleep 3
          done
      
      # ====================================================================
      # 🧪 8. 健康检查测试
      # ====================================================================
      - name: 🧪 数据库连接测试
        run: |
          echo "🧪 测试数据库连接..."
          
          # Ping 测试
          docker-compose exec -T db mysqladmin ping -h localhost -u root -ptest_root_password
          
          # 查询测试
          docker-compose exec -T db mysql -u root -ptest_root_password -e "SELECT 1 as test;" magicai
          
          echo "✅ 数据库连接测试通过"
      
      - name: 🧪 Redis 连接测试
        run: |
          echo "🧪 测试 Redis 连接..."
          
          # Ping 测试
          docker-compose exec -T redis redis-cli ping
          
          # 写入和读取测试
          docker-compose exec -T redis redis-cli SET test_key "test_value"
          docker-compose exec -T redis redis-cli GET test_key
          
          echo "✅ Redis 连接测试通过"
      
      - name: 🧪 Web 应用健康检查
        run: |
          echo "🧪 测试 Web 应用 (http://localhost:8000)..."
          
          # 主页测试
          if curl -f -s http://localhost:8000 > /dev/null; then
            echo "✅ Web 应用主页可访问"
          else
            echo "⚠️ Web 应用主页可能还在初始化"
            curl -v http://localhost:8000 || true
          fi
      
      - name: 🧪 Python 后端健康检查
        run: |
          echo "🧪 测试 Python 后端 (http://localhost:8080/health)..."
          
          # 健康检查端点
          response=$(curl -f -s http://localhost:8080/health)
          echo "响应: $response"
          
          # 验证响应包含 healthy 状态
          if echo "$response" | grep -q "healthy"; then
            echo "✅ Python 后端健康检查通过"
          else
            echo "❌ Python 后端健康检查失败"
            exit 1
          fi
      
      - name: 🧪 API 端点测试
        run: |
          echo "🧪 测试 API 端点..."
          
          # 测试 Python 后端 status 端点
          echo "📍 测试 /status 端点..."
          response=$(curl -f -s http://localhost:8080/status)
          echo "响应: $response"
          
          # 测试 API status 端点
          echo "📍 测试 /api/status 端点..."
          response=$(curl -f -s http://localhost:8080/api/status)
          echo "响应: $response"
          
          echo "✅ API 端点测试通过"
      
      # ====================================================================
      # 📊 9. 运行数据库迁移
      # ====================================================================
      - name: 📊 运行数据库迁移
        run: |
          echo "📊 运行数据库迁移..."
          
          # 生成应用密钥（如果需要）
          docker-compose exec -T web php artisan key:generate --force || true
          
          # 运行迁移
          docker-compose exec -T web php artisan migrate --force || echo "⚠️ 迁移可能已运行或表不存在"
          
          echo "✅ 数据库迁移完成"
      
      - name: 🗑️ 清理缓存
        run: |
          echo "🗑️ 清理应用缓存..."
          
          # 清理配置缓存
          docker-compose exec -T web php artisan config:clear || true
          
          # 清理路由缓存
          docker-compose exec -T web php artisan route:clear || true
          
          # 清理视图缓存
          docker-compose exec -T web php artisan view:clear || true
          
          echo "✅ 缓存清理完成"
      
      - name: 🎨 编译前端资源
        run: |
          echo "🎨 编译前端资源..."
          
          # 检查是否有 npm 构建配置
          if docker-compose exec -T web test -f package.json; then
            # 安装依赖（如果需要）
            docker-compose exec -T web npm install --silent || echo "⚠️ npm install 可能有问题"
            
            # 构建前端
            docker-compose exec -T web npm run build || echo "⚠️ 前端构建可能有问题"
            
            echo "✅ 前端资源编译完成"
          else
            echo "ℹ️ 未找到 package.json，跳过前端编译"
          fi
      
      # ====================================================================
      # ✅ 10. 验证部署
      # ====================================================================
      - name: ✅ 验证所有容器运行中
        run: |
          echo "✅ 验证容器状态..."
          
          # 显示所有容器状态
          docker-compose ps
          
          # 检查每个服务是否运行
          services=("db" "redis" "web" "python-backend")
          for service in "${services[@]}"; do
            if docker-compose ps | grep -q "$service.*Up"; then
              echo "✅ $service 正在运行"
            else
              echo "❌ $service 未运行"
              docker-compose logs "$service"
              exit 1
            fi
          done
          
          echo "✅ 所有容器验证通过"
      
      - name: ✅ 验证端点可访问
        run: |
          echo "✅ 验证应用端点..."
          
          # 验证 Web 应用
          if curl -f -s http://localhost:8000 > /dev/null; then
            echo "✅ Web 应用可访问: http://localhost:8000"
          else
            echo "⚠️ Web 应用访问有问题"
          fi
          
          # 验证 Python 后端 health
          if curl -f -s http://localhost:8080/health > /dev/null; then
            echo "✅ Python 后端健康检查: http://localhost:8080/health"
          else
            echo "❌ Python 后端健康检查失败"
            exit 1
          fi
          
          # 验证 Python 后端 status
          if curl -f -s http://localhost:8080/status > /dev/null; then
            echo "✅ Python 后端状态端点: http://localhost:8080/status"
          else
            echo "⚠️ Python 后端状态端点访问有问题"
          fi
          
          echo "✅ 端点验证完成"
      
      # ====================================================================
      # 📋 11. 显示部署状态
      # ====================================================================
      - name: 📋 显示部署摘要
        if: always()
        run: |
          echo ""
          echo "════════════════════════════════════════════════════════════════"
          echo "  📋 部署摘要"
          echo "════════════════════════════════════════════════════════════════"
          echo ""
          echo "⏰ 部署完成时间: $(date)"
          echo ""
          echo "📦 容器状态:"
          docker-compose ps
          echo ""
          echo "📊 资源使用情况:"
          docker stats --no-stream
          echo ""
          echo "🌐 可访问的服务:"
          echo "  ✓ Web 应用: http://localhost:8000"
          echo "  ✓ Python 后端: http://localhost:8080"
          echo "  ✓ Python 健康检查: http://localhost:8080/health"
          echo "  ✓ Python 状态: http://localhost:8080/status"
          echo "  ✓ API 状态: http://localhost:8080/api/status"
          echo "  ✓ MySQL: localhost:3306"
          echo "  ✓ Redis: localhost:6379"
          echo ""
          echo "📝 查看日志命令:"
          echo "  docker-compose logs -f"
          echo "  docker-compose logs web"
          echo "  docker-compose logs python-backend"
          echo ""
          echo "════════════════════════════════════════════════════════════════"
      
      # ====================================================================
      # 🧹 12. 清理（可选，仅在需要时启用）
      # ====================================================================
      - name: 🧹 停止服务并清理
        if: always()
        run: |
          echo "🧹 停止服务..."
          docker-compose down -v
          echo "✅ 清理完成"
