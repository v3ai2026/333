name: Deploy to GitHub Pages

# æ­¤å·¥ä½œæµå°†é™æ€å†…å®¹éƒ¨ç½²åˆ° GitHub Pages
# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° main åˆ†æ”¯æˆ–æ‰‹åŠ¨è§¦å‘

on:
  push:
    branches:
      - main
  workflow_dispatch:

# è®¾ç½®å¿…è¦çš„æƒé™
permissions:
  contents: read      # è¯»å–ä»“åº“å†…å®¹
  pages: write        # å†™å…¥ GitHub Pages
  id-token: write     # ç”¨äºéƒ¨ç½²è®¤è¯

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€æ—¶é—´åªè¿è¡Œä¸€ä¸ªéƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: é…ç½® GitHub Pages
      # âš ï¸ é‡è¦ï¼šå¦‚æœæ­¤æ­¥éª¤å¤±è´¥ï¼Œè¯·ç¡®ä¿å·²åœ¨ä»“åº“è®¾ç½®ä¸­å¯ç”¨ GitHub Pages
      # è®¾ç½®è·¯å¾„ï¼šSettings â†’ Pages â†’ Source: GitHub Actions
      # è¯¦ç»†è¯´æ˜ï¼šdocs/GITHUB_PAGES_SETUP.md
      - name: ğŸ“¦ Setup Pages
        id: pages
        uses: actions/configure-pages@v4
        continue-on-error: true
      
      # æ­¥éª¤ 2.5: æ£€æŸ¥ Pages é…ç½®çŠ¶æ€
      - name: âš ï¸ Check Pages Configuration
        if: steps.pages.outcome == 'failure'
        run: |
          echo "=============================================="
          echo "âŒ GitHub Pages é…ç½®å¤±è´¥ï¼"
          echo "=============================================="
          echo ""
          echo "è¿™é€šå¸¸æ„å‘³ç€ GitHub Pages æœªåœ¨ä»“åº“ä¸­å¯ç”¨ã€‚"
          echo ""
          echo "è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å¯ç”¨ GitHub Pagesï¼š"
          echo ""
          echo "1. è¿›å…¥ä»“åº“é¡µé¢"
          echo "2. ç‚¹å‡» Settingsï¼ˆè®¾ç½®ï¼‰"
          echo "3. åœ¨å·¦ä¾§èœå•ä¸­æ‰¾åˆ° Pages"
          echo "4. åœ¨ Sourceï¼ˆæºï¼‰éƒ¨åˆ†ï¼Œé€‰æ‹© 'GitHub Actions'"
          echo "5. ä¿å­˜è®¾ç½®"
          echo ""
          echo "å®Œæ•´è®¾ç½®æŒ‡å—ï¼š"
          echo "https://github.com/v3ai2026/333/blob/main/docs/GITHUB_PAGES_SETUP.md"
          echo ""
          echo "å¯ç”¨ Pages åï¼Œè¯·é‡æ–°è¿è¡Œæ­¤å·¥ä½œæµã€‚"
          echo "=============================================="
          exit 1

      # æ­¥éª¤ 3: æ„å»ºé™æ€ç«™ç‚¹
      # æ­¤æ­¥éª¤åˆ›å»º _site ç›®å½•å¹¶å‡†å¤‡è¦éƒ¨ç½²çš„å†…å®¹
      - name: ğŸ”¨ Build Static Site
        run: |
          echo "=============================================="
          echo "ğŸ”¨ å¼€å§‹æ„å»ºé™æ€ç«™ç‚¹..."
          echo "=============================================="
          echo ""
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p _site
          
          # å¤åˆ¶ public ç›®å½•å†…å®¹ï¼ˆLaravel çš„å…¬å…±èµ„æºï¼‰
          if [ -d "public" ]; then
            echo "ğŸ“ å¤åˆ¶ public ç›®å½•..."
            cp -r public/* _site/
            echo "âœ“ å·²å¤åˆ¶ public ç›®å½•å†…å®¹"
          else
            echo "âš ï¸  æœªæ‰¾åˆ° public ç›®å½•"
          fi
          
          # ç¡®ä¿å­˜åœ¨ index.html
          if [ ! -f "_site/index.html" ]; then
            echo ""
            echo "âš ï¸  è­¦å‘Šï¼šæœªæ‰¾åˆ° index.html"
            echo "ğŸ“ åˆ›å»ºé»˜è®¤é¦–é¡µ..."
            cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>MagicAI v9.9 - AI SaaS Platform</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: #fff;
                      min-height: 100vh;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      padding: 20px;
                  }
                  .container {
                      max-width: 800px;
                      background: rgba(255, 255, 255, 0.1);
                      backdrop-filter: blur(10px);
                      border-radius: 20px;
                      padding: 60px 40px;
                      text-align: center;
                      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                  }
                  h1 {
                      font-size: 3.5em;
                      margin-bottom: 20px;
                      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
                  }
                  p {
                      font-size: 1.2em;
                      margin-bottom: 30px;
                      opacity: 0.9;
                  }
                  .links {
                      display: flex;
                      gap: 20px;
                      justify-content: center;
                      flex-wrap: wrap;
                  }
                  a {
                      display: inline-block;
                      padding: 15px 30px;
                      background: rgba(255, 255, 255, 0.2);
                      color: #fff;
                      text-decoration: none;
                      border-radius: 10px;
                      font-weight: 600;
                      transition: all 0.3s;
                      border: 2px solid rgba(255, 255, 255, 0.3);
                  }
                  a:hover {
                      background: rgba(255, 255, 255, 0.3);
                      transform: translateY(-2px);
                      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                  }
                  .status {
                      margin-top: 40px;
                      padding: 20px;
                      background: rgba(255, 255, 255, 0.1);
                      border-radius: 10px;
                  }
                  .badge {
                      display: inline-block;
                      margin: 5px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ¯ MagicAI v9.9</h1>
                  <p>AI-Powered SaaS Platform | Laravel 10 + FastAPI</p>
                  <div class="links">
                      <a href="https://github.com/v3ai2026/333" target="_blank">ğŸ“¦ GitHub Repository</a>
                      <a href="https://github.com/v3ai2026/333/blob/main/docs/QUICK_START.md" target="_blank">ğŸš€ Quick Start</a>
                      <a href="https://github.com/v3ai2026/333/blob/main/docs/DEPLOYMENT_GUIDE.md" target="_blank">ğŸ“– Deployment Guide</a>
                  </div>
                  <div class="status">
                      <p><strong>ğŸ“Š Project Status</strong></p>
                      <div class="badge">
                          <img src="https://github.com/v3ai2026/333/actions/workflows/pages.yml/badge.svg" alt="Pages">
                      </div>
                      <div class="badge">
                          <img src="https://github.com/v3ai2026/333/actions/workflows/deploy.yml/badge.svg" alt="Deploy">
                      </div>
                  </div>
              </div>
          </body>
          </html>
          EOF
            echo "âœ“ å·²åˆ›å»ºé»˜è®¤é¦–é¡µ"
          else
            echo "âœ“ æ‰¾åˆ° index.html"
          fi
          
          # åˆ›å»º .nojekyll æ–‡ä»¶ä»¥ç¦ç”¨ Jekyll å¤„ç†
          echo ""
          echo "ğŸ“ åˆ›å»º .nojekyll æ–‡ä»¶..."
          touch _site/.nojekyll
          echo "âœ“ Jekyll å¤„ç†å·²ç¦ç”¨"
          
          # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶
          echo ""
          echo "ğŸ“‚ ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨ï¼š"
          echo "=============================================="
          ls -lah _site/ | head -20
          echo "=============================================="
          echo ""
          echo "âœ… é™æ€ç«™ç‚¹æ„å»ºæˆåŠŸï¼"
          echo ""

      # æ­¥éª¤ 4: ä¸Šä¼ æ„å»ºäº§ç‰©
      # å°†æ„å»ºçš„é™æ€æ–‡ä»¶ä¸Šä¼ åˆ° GitHub Actions
      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      # æ­¥éª¤ 5: éƒ¨ç½²åˆ° GitHub Pages
      # è¿™æ˜¯å®é™…çš„éƒ¨ç½²æ­¥éª¤
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # æ­¥éª¤ 6: éƒ¨ç½²æˆåŠŸé€šçŸ¥
      # æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯å’Œç½‘ç«™ URL
      - name: âœ… Deployment Complete
        run: |
          echo "=============================================="
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "=============================================="
          echo ""
          echo "æ‚¨çš„ç½‘ç«™ç°åœ¨å·²ä¸Šçº¿ï¼š"
          echo "ğŸ”— https://v3ai2026.github.io/333/"
          echo ""
          echo "æ³¨æ„äº‹é¡¹ï¼š"
          echo "â€¢ æ›´æ”¹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ‰èƒ½æ˜¾ç¤ºåœ¨ç½‘ç«™ä¸Š"
          echo "â€¢ CDN ç¼“å­˜æ›´æ–°å¯èƒ½éœ€è¦ 5-10 åˆ†é’Ÿ"
          echo "â€¢ å¦‚æœçœ‹ä¸åˆ°æ›´æ”¹ï¼Œè¯·æ¸…é™¤æµè§ˆå™¨ç¼“å­˜"
          echo ""
          echo "ç›¸å…³é“¾æ¥ï¼š"
          echo "â€¢ ğŸ“– è®¾ç½®æŒ‡å—: docs/GITHUB_PAGES_SETUP.md"
          echo "â€¢ ğŸš€ éƒ¨ç½²æ–‡æ¡£: docs/DEPLOYMENT_GUIDE.md"
          echo "â€¢ ğŸ”§ å·¥ä½œæµè¯´æ˜: .github/workflows/README.md"
          echo "=============================================="
